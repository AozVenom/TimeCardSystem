@page
@model TimeCardSystem.API.Pages.Admin.UsersModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "User Management";
    ViewData["ActivePage"] = "Users";
    Layout = "_TimeEntriesLayout";

    var requestToken = Antiforgery.GetAndStoreTokens(HttpContext).RequestToken;
}

<input type="hidden" name="__RequestVerificationToken" value="@requestToken" />

<div class="admin-container">
    <div class="page-header">
        <h2>User Management</h2>
        <div class="action-buttons">
            <button type="button" class="btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fas fa-plus"></i> Add User
            </button>
            <a href="/Admin/Users?handler=ExportUsers" class="btn-secondary">
                <i class="fas fa-file-export"></i> Export
            </a>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-container">
        <div class="search-box">
            <input type="text" id="searchUsers" placeholder="Search users..." class="form-control">
            <i class="fas fa-search"></i>
        </div>
        <div class="filter-options">
            <select id="roleFilter" class="form-control">
                <option value="">All Roles</option>
                <option value="1">Employee</option>
                <option value="2">Manager</option>
                <option value="3">Administrator</option>
            </select>
            <select id="statusFilter" class="form-control">
                <option value="">All Statuses</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessageContainer" class="@(string.IsNullOrEmpty(Model.StatusMessage) ? "d-none" : "")">
        <div class="alert @(Model.IsError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            <span id="statusMessageText">@Model.StatusMessage</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-responsive">
        <table class="table table-striped" id="usersTable">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAllUsers">
                    </th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    <tr data-user-id="@user.Id">
                        <td>
                            <input type="checkbox" class="user-checkbox" value="@user.Id">
                        </td>
                        <td>@user.FirstName @user.LastName</td>
                        <td>@user.Email</td>
                        <td>
                            <span class="role-badge role-@user.Role.ToString().ToLower()">
                                @user.Role
                            </span>
                        </td>
                        <td>
                            <span class="status-badge @(user.IsActive ? "status-active" : "status-inactive")">
                                @(user.IsActive ? "Active" : "Inactive")
                            </span>
                        </td>
                        <td>@user.CreatedAt.ToString("MM/dd/yyyy")</td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn-action btn-edit" data-user-id="@user.Id" title="Edit User">
                                    <i class="fas fa-edit"></i>
                                </button>
                                @if (user.IsActive)
                                {
                                    <button type="button" class="btn-action btn-disable" data-user-id="@user.Id" title="Disable User">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn-action btn-enable" data-user-id="@user.Id" title="Enable User">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                }
                                <button type="button" class="btn-action btn-delete" data-user-id="@user.Id" title="Delete User">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <div class="items-per-page">
            <label for="itemsPerPage">Show: </label>
            <select id="itemsPerPage" class="form-control">
                @if (Model.PageSize == 10)
                {
                    <option value="10" selected>10</option>
                }
                else
                {
                    <option value="10">10</option>
                }

                @if (Model.PageSize == 25)
                {
                    <option value="25" selected>25</option>
                }
                else
                {
                    <option value="25">25</option>
                }

                @if (Model.PageSize == 50)
                {
                    <option value="50" selected>50</option>
                }
                else
                {
                    <option value="50">50</option>
                }

                @if (Model.PageSize == 100)
                {
                    <option value="100" selected>100</option>
                }
                else
                {
                    <option value="100">100</option>
                }
            </select>
        </div>
        <nav aria-label="User pagination">
            <ul class="pagination">
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == Model.CurrentPage)
                    {
                        <li class="page-item active">
                            <a class="page-link" href="/Admin/Users?page=@i&pageSize=@Model.PageSize">@i</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Admin/Users?page=@i&pageSize=@Model.PageSize">@i</a>
                        </li>
                    }
                }
            </ul>
        </nav>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions">
        <select id="bulkActionSelect" class="form-control">
            <option value="">Bulk Actions</option>
            <option value="activate">Activate</option>
            <option value="deactivate">Deactivate</option>
            <option value="delete">Delete</option>
            <option value="changeRole">Change Role</option>
        </select>
        <button id="applyBulkAction" class="btn-secondary">Apply</button>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createUserForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="createFirstName">First Name</label>
                        <input type="text" class="form-control" id="createFirstName" name="FirstName" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="createLastName">Last Name</label>
                        <input type="text" class="form-control" id="createLastName" name="LastName" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="createEmail">Email</label>
                        <input type="email" class="form-control" id="createEmail" name="Email" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="createRole">Role</label>
                        <select class="form-control" id="createRole" name="Role" required>
                            <option value="1">Employee</option>
                            <option value="2">Manager</option>
                            <option value="3">Administrator</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="createPassword">Password</label>
                        <input type="password" class="form-control" id="createPassword" name="Password" required>
                        <small class="form-text text-muted">User will be prompted to change this on first login.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="Id">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="editFirstName">First Name</label>
                        <input type="text" class="form-control" id="editFirstName" name="FirstName" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="editLastName">Last Name</label>
                        <input type="text" class="form-control" id="editLastName" name="LastName" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="editEmail">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="Email" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="editRole">Role</label>
                        <select class="form-control" id="editRole" name="Role" required>
                            <option value="1">Employee</option>
                            <option value="2">Manager</option>
                            <option value="3">Administrator</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="resetPassword" name="ResetPassword">
                        <label class="form-check-label" for="resetPassword">Reset Password</label>
                    </div>
                    <div class="form-group password-reset-group" style="display: none;">
                        <label for="newPassword">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="NewPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                <p class="text-danger">Warning: This will permanently delete all associated time entries and schedules.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn-danger">Delete User</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/admin.js" asp-append-version="true"></script>
}